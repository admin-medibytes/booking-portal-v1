# Database Schema

Transform the conceptual data models into concrete database schemas:

```sql
-- Generated by Better Auth CLI
-- Tables: users, accounts, sessions, organizations, organizationMembers, 
-- teams, teamMembers, verifications, etc.

-- Application-specific tables

-- Specialists table
CREATE TABLE specialists (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL REFERENCES users(id),
  acuity_calendar_id VARCHAR(255) NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  specialty VARCHAR(255) NOT NULL,
  location VARCHAR(255), -- NULL for telehealth-only
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_specialists_user_id (user_id),
  INDEX idx_specialists_active (is_active),
  INDEX idx_specialists_acuity_calendar (acuity_calendar_id)
);

-- Bookings table
CREATE TABLE bookings (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  acuity_appointment_id VARCHAR(255) NOT NULL UNIQUE,
  specialist_id VARCHAR(255) NOT NULL REFERENCES specialists(id),
  organization_id VARCHAR(255) NOT NULL REFERENCES organizations(id),
  team_id VARCHAR(255) REFERENCES teams(id),
  created_by_id VARCHAR(255) NOT NULL REFERENCES users(id),
  created_for_id VARCHAR(255) REFERENCES users(id), -- For impersonation
  examinee_name VARCHAR(255) NOT NULL,
  examinee_phone VARCHAR(50) NOT NULL,
  examinee_email VARCHAR(255),
  appointment_date TIMESTAMP WITH TIME ZONE NOT NULL,
  appointment_type VARCHAR(50) NOT NULL CHECK (appointment_type IN ('in_person', 'telehealth')),
  meeting_link TEXT, -- For telehealth appointments
  status VARCHAR(50) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'closed', 'archived')),
  current_progress VARCHAR(50) NOT NULL DEFAULT 'scheduled' 
    CHECK (current_progress IN ('scheduled', 'rescheduled', 'cancelled', 'no_show', 
                               'generating_report', 'report_generated', 'payment_received')),
  source VARCHAR(50) NOT NULL DEFAULT 'portal' CHECK (source IN ('portal', 'acuity_direct')),
  external_created_by VARCHAR(255), -- Who created in Acuity
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_bookings_specialist (specialist_id),
  INDEX idx_bookings_organization (organization_id),
  INDEX idx_bookings_team (team_id),
  INDEX idx_bookings_created_by (created_by_id),
  INDEX idx_bookings_appointment_date (appointment_date),
  INDEX idx_bookings_status (status),
  INDEX idx_bookings_acuity (acuity_appointment_id),
  INDEX idx_bookings_search (examinee_name, examinee_phone)
);

-- Booking progress history
CREATE TABLE booking_progress (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  booking_id VARCHAR(255) NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
  progress VARCHAR(50) NOT NULL 
    CHECK (progress IN ('scheduled', 'rescheduled', 'cancelled', 'no_show', 
                        'generating_report', 'report_generated', 'payment_received')),
  changed_by_id VARCHAR(255) NOT NULL REFERENCES users(id),
  changed_for_id VARCHAR(255) REFERENCES users(id), -- For impersonation
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_booking_progress_booking (booking_id),
  INDEX idx_booking_progress_created (created_at)
);

-- Documents table
CREATE TABLE documents (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  booking_id VARCHAR(255) NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
  uploaded_by_id VARCHAR(255) NOT NULL REFERENCES users(id),
  s3_key VARCHAR(500) NOT NULL UNIQUE,
  file_name VARCHAR(255) NOT NULL,
  file_size BIGINT NOT NULL,
  mime_type VARCHAR(100) NOT NULL,
  category VARCHAR(50) NOT NULL 
    CHECK (category IN ('consent_form', 'brief', 'report', 'dictation', 'other')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_documents_booking (booking_id),
  INDEX idx_documents_category (category),
  INDEX idx_documents_uploaded_by (uploaded_by_id)
);

-- Audit logs table
CREATE TABLE audit_logs (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL, -- References users but no FK for data retention
  impersonated_user_id VARCHAR(255), -- References users but no FK
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(255) NOT NULL,
  metadata JSONB,
  ip_address INET NOT NULL,
  user_agent TEXT,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_audit_logs_user (user_id),
  INDEX idx_audit_logs_resource (resource_type, resource_id),
  INDEX idx_audit_logs_timestamp (timestamp),
  INDEX idx_audit_logs_action (action)
);

-- Webhook events table (for tracking Acuity webhooks)
CREATE TABLE webhook_events (
  id VARCHAR(255) PRIMARY KEY DEFAULT gen_random_uuid(),
  source VARCHAR(50) NOT NULL DEFAULT 'acuity',
  event_type VARCHAR(100) NOT NULL,
  resource_id VARCHAR(255) NOT NULL, -- Acuity appointment ID
  payload JSONB NOT NULL,
  processed_at TIMESTAMP WITH TIME ZONE,
  error TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_webhook_events_source (source),
  INDEX idx_webhook_events_resource (resource_id),
  INDEX idx_webhook_events_processed (processed_at),
  INDEX idx_webhook_events_created (created_at)
);

-- Triggers for updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_specialists_updated_at BEFORE UPDATE ON specialists
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_bookings_updated_at BEFORE UPDATE ON bookings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Views for common queries
CREATE VIEW active_bookings AS
SELECT 
  b.*,
  s.name as specialist_name,
  s.specialty,
  s.location as specialist_location,
  o.name as organization_name,
  t.name as team_name,
  u.name as created_by_name,
  i.name as created_for_name
FROM bookings b
JOIN specialists s ON b.specialist_id = s.id
JOIN organizations o ON b.organization_id = o.id
LEFT JOIN teams t ON b.team_id = t.id
JOIN users u ON b.created_by_id = u.id
LEFT JOIN users i ON b.created_for_id = i.id
WHERE b.status = 'active';

-- Indexes for performance
CREATE INDEX idx_bookings_composite_filter 
  ON bookings(status, appointment_date, specialist_id) 
  WHERE status = 'active';

CREATE INDEX idx_documents_booking_category 
  ON documents(booking_id, category);

-- Constraints
ALTER TABLE bookings 
  ADD CONSTRAINT valid_appointment_date 
  CHECK (appointment_date > created_at);

ALTER TABLE documents 
  ADD CONSTRAINT valid_file_size 
  CHECK (file_size > 0 AND file_size <= 524288000); -- 500MB max
```
