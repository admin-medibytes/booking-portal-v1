# Story 2.6: Specialist Appointment Types Sync and Selection

## Status

Done

## Story

**As a** referrer creating a booking,
**I want** to select an appointment type after choosing a specialist,
**so that** the booking configuration matches the specialist’s allowed services and Acuity.

## Acceptance Criteria

1. Database includes persisted appointment types and a per‑specialist mapping of enabled types.
2. Acuity originals are preserved: name, description, and raw payload are stored so we can compare and recover.
3. Per‑specialist overrides exist for display name and description; UI shows effective values (override if set, else Acuity), and indicates the source.
4. Admins can sync appointment types from Acuity and manage which types each specialist offers (enable/disable; optional notes/price; edit overrides).
5. `GET /api/specialists/:id/appointment-types` returns only enabled, active types for the selected specialist; supports `?refresh=true` to re‑sync from Acuity before returning; payload includes both source and effective values.
6. Booking flow shows effective appointment types based on selected specialist; selection updates downstream availability queries.
7. Booking creation validates chosen appointment type is enabled for the specialist and still valid in Acuity at submit time.
8. Audit logs emitted for admin sync actions, override changes, and mapping changes.
9. Reasonable performance: local reads from DB with optional background sync; UI does not block on Acuity.

## Tasks / Subtasks

- [x] Add schema for appointment types and specialist mappings (Drizzle)
  - [x] `appointment_types` with Acuity ID, acuityName, acuityDescription, duration, category, active, lastSyncedAt, raw (jsonb), timestamps
  - [x] `specialist_appointment_types` with specialistId, appointmentTypeId, enabled, customDisplayName (nullable), customDescription (nullable), customPrice (nullable), notes (nullable), timestamps
  - [x] Generate and apply migrations
- [x] Backend services and repositories
  - [x] Upsert sync from Acuity → `appointment_types` (preserve originals and raw payload)
  - [x] CRUD for `specialist_appointment_types` (bulk enable/disable and update overrides)
  - [x] Validation helper for booking creation to assert mapping + current Acuity validity
- [x] API endpoints (Hono)
  - [x] Update `GET /api/specialists/:id/appointment-types` to read from DB; `?refresh=true` triggers sync first; response includes `effective` and `source` fields
  - [x] `POST /api/admin/specialists/:id/appointment-types/sync` → refresh catalog and optionally auto‑enable by simple heuristic
  - [x] `PUT /api/admin/specialists/:id/appointment-types` → bulk update: `{ items: Array<{ appointmentTypeId: string, enabled?: boolean, customDisplayName?: string | null, customDescription?: string | null }> }`
- [x] Admin UI (`page.tsx` + dialog)
  - [x] Add management UI in Specialists admin to list all appointment types with enabled state per specialist, category filters
  - [x] Show Acuity originals (name/description) alongside editable overrides; compute and display effective values and a "Using override" indicator
  - [x] Actions: Sync from Acuity, Enable/Disable selected, Edit overrides, show last synced timestamp
  - [x] Optimistic updates with toast feedback and rollback on error
- [x] Booking UI (`AppointmentTypeSelect.tsx`)
  - [x] Fetch via updated endpoint and display only enabled, active types
  - [x] Render effective name/description; optionally show subtle badge if overridden
  - [x] Ensure availability queries include selected `appointmentTypeId`
- [x] Logging & audit
  - [x] Emit audit events on sync, override edits, and mapping changes; include acting user id and specialist id

## Data Models (Drizzle outline)

- `appointment_types`
  - `id (uuid, pk)`
  - `acuityAppointmentTypeId (int, unique)`
  - `acuityName (text, not null)`
  - `acuityDescription (text, nullable)`
  - `durationMinutes (int, not null)`
  - `category (text, nullable)`
  - `active (boolean, default true)`
  - `lastSyncedAt (timestamp, nullable)`
  - `raw (jsonb, nullable)`
  - `createdAt (timestamp)` / `updatedAt (timestamp)`
- `specialist_appointment_types`
  - `specialistId (text, fk → specialists.id, not null)`
  - `appointmentTypeId (uuid, fk → appointment_types.id, not null)`
  - `enabled (boolean, default true, not null)`
  - `customDisplayName (text, nullable)`
  - `customDescription (text, nullable)`
  - `customPrice (int, nullable)`
  - `notes (text, nullable)`
  - `createdAt (timestamp)` / `updatedAt (timestamp)`
  - Unique index on `(specialistId, appointmentTypeId)`

### Effective fields (computed in queries)

- `effectiveName = COALESCE(sat.customDisplayName, at.acuityName)`
- `effectiveDescription = COALESCE(sat.customDescription, at.acuityDescription)`
- `sourceName = sat.customDisplayName IS NULL ? 'acuity' : 'override'`

## API Specification

- `GET /api/specialists/:id/appointment-types`
  - Query: `refresh?=true|false`
  - Response:
    ```json
    {
      "success": true,
      "data": [
        {
          "id": "uuid", // appointment_types.id
          "acuityAppointmentTypeId": 123,
          "name": "Effective Name",
          "description": "Effective Description",
          "duration": 60,
          "category": "General",
          "source": {
            "name": "override|acuity",
            "description": "override|acuity"
          }
        }
      ]
    }
    ```
- `POST /api/admin/specialists/:id/appointment-types/sync`
  - Body: `{ "strategy": "none" | "auto-enable-by-category" }`
  - Response: `{ success: true, synced: number, enabledChanged?: number, lastSyncedAt: string }`
- `PUT /api/admin/specialists/:id/appointment-types`
  - Body: `{ items: Array<{ appointmentTypeId: string, enabled?: boolean, customDisplayName?: string | null, customDescription?: string | null }> }`
  - Response: `{ success: true, updated: number }`

## UI Specification

- Admin Specialists (`src/app/(dashboard)/admin/users/specialists/page.tsx`)
  - Add an “Appointment Types” management panel (e.g., inside `SpecialistDetailDialog` as a tab)
  - Table/grid: Effective Name, Duration, Category, Enabled (toggle), Effective Description (hover)
  - Show Acuity originals (read-only) and editable overrides (inputs), with an indicator when overrides are active
  - Controls: Sync from Acuity, Filter by category, Bulk enable/disable, Save overrides
  - Show “Last synced: <timeago>” and success/error toasts
- Booking flow component (`src/components/bookings/AppointmentTypeSelect.tsx`)
  - Source: `GET /api/specialists/:id/appointment-types`
  - Render cards with effective name/description; show category badge and duration
  - Selection updates parent with `{ id, acuityAppointmentTypeId, name, duration, category }`

## Validation & Guardrails

- On booking submission, validate appointment type belongs to specialist and is active; optionally re‑verify with Acuity to guard against drift.
- Hide disabled or inactive types from selection.
- Emit audit events for admin changes, overrides edits, and syncs.

## File Locations & Impact

- Schema: `src/server/db/schema/specialists.ts` (add new tables) or a new schema file if preferred
- Services: `src/server/services/acuity.service.ts`

## Dev Agent Record

### Agent Model Used

- claude-opus-4-1-20250805 (James - Full Stack Developer)

### File List

- `src/server/db/schema/specialists.ts` - Added appointment_types and specialist_appointment_types tables with relations
- `src/server/db/migrations/0004_add_appointment_types_tables.sql` - Created migration for new tables
- `src/server/repositories/appointment-type.repository.ts` - Created repository for appointment type operations
- `src/server/routes/specialists.routes.ts` - Updated with appointment type endpoints including admin endpoint
- `src/server/services/booking.service.ts` - Added appointment type validation for bookings
- `src/components/bookings/AppointmentTypeSelect.tsx` - Updated component for new data structure
- `src/app/(dashboard)/admin/users/specialists/components/SpecialistDetailDialog.tsx` - Added appointment types tab
- `src/app/(dashboard)/admin/users/specialists/components/AppointmentTypesManagement.tsx` - Created appointment types management UI

### Change Log

1. Added database schema for appointment_types and specialist_appointment_types tables
2. Created comprehensive repository with upsert, CRUD, and validation methods
3. Implemented API endpoints for appointment type management including admin-specific endpoint
4. Updated booking service to validate appointment types during creation
5. Enhanced UI component to display effective values and source indicators
6. Added audit logging for all appointment type operations
7. Created admin management UI with appointment types tab in SpecialistDetailDialog
8. Implemented AppointmentTypesManagement component with full CRUD operations and optimistic updates

### Completion Notes

- All backend functionality completed including database, repositories, and API endpoints
- Booking flow updated to support appointment type selection with validation
- Admin UI fully implemented with appointment types management in specialist detail dialog
- Migration file created but needs to be applied manually by user
- Admin can now sync, enable/disable, and override appointment types per specialist
