# Story 3.3: Portal-Proxied Download System

## Status
Ready for Review

## Story
**As a** developer,  
**I want** to implement secure document downloads through the application,  
**so that** all PHI access is validated and audited.

## Acceptance Criteria
1. Download endpoint validates user permissions before generating S3 access
2. Portal proxy streams documents without exposing S3 URLs
3. Downloads work for all supported file types and sizes
4. Access attempts logged with user, document, timestamp, and outcome
5. Expired session redirects to login instead of showing errors
6. Download progress visible for large files
7. Proper Content-Type headers set for browser handling
8. Rate limiting prevents abuse of download endpoints

## Tasks / Subtasks
- [x] Enhance download endpoint security (AC: 1, 2, 5)
  - [x] Update GET /api/documents/:id endpoint in documents.routes.ts
  - [x] Add comprehensive permission validation before download
  - [x] Implement proper session checking with redirect on expiry
  - [x] Ensure S3 URLs are never exposed in responses
  - [x] Add request validation with ArkType schemas
- [x] Implement secure streaming (AC: 2, 3, 7)
  - [x] Update documentService.downloadDocument to return proper stream
  - [x] Set correct Content-Type headers based on mimeType
  - [x] Add Content-Disposition header for proper file naming
  - [x] Include Content-Length for download progress
  - [x] Handle streaming errors gracefully
  - [x] Support range requests for resumable downloads
- [x] Add comprehensive audit logging (AC: 4)
  - [x] Log document.accessed event when download starts
  - [x] Log document.downloaded event on completion
  - [x] Include download size and duration in metadata
  - [x] Log failed access attempts with reason
  - [x] Track IP address and user agent
  - [x] Handle impersonation context in logs
- [x] Implement download rate limiting (AC: 8)
  - [x] Create document download rate limiter (100/hour per user)
  - [x] Add rate limit headers to responses
  - [x] Return 429 with retry-after header when exceeded
  - [x] Use Redis for distributed rate limiting
  - [x] Exclude rate limits for admin users
- [x] Add client-side download handling (AC: 6)
  - [x] Update document list to use secure download method
  - [x] Implement download progress indicator for large files
  - [x] Handle download initiation with proper auth
  - [x] Show toast notifications for download status
  - [x] Add retry mechanism for failed downloads
- [x] Enhance error handling (AC: 5, 7)
  - [x] Return 401 and redirect to login for expired sessions
  - [x] Provide specific error messages for different failures
  - [x] Handle S3 service errors gracefully
  - [x] Ensure no sensitive information in error responses
  - [x] Add proper error logging without exposing internals

## Dev Notes

### Previous Story Insights
- Basic GET /api/documents/:id endpoint exists but needs security hardening
- QA identified "Download endpoint opens in new tab without visible auth validation"
- S3 service supports pre-signed URLs with 5-minute expiry
- Document service has basic access control checks
- Audit logging service available for tracking
- Upload rate limiting at 50/hour implemented
[Source: Stories 3.1 and 3.2 completion notes]

### Security Architecture
**Portal Proxy Pattern**:
- All document access flows through application layer
- No direct S3 URLs exposed to clients
- Every download authenticated, authorized, and audited
- Streaming from S3 through application to client
[Source: Architecture analysis]

**Access Control Hierarchy**:
```typescript
// Document access verification logic
1. Document uploader always has access
2. Access inherits from booking permissions
3. Organization/team boundaries enforced
4. Admin impersonation tracked separately
```
[Source: architecture/components.md#document-service]

### API Specifications
**Enhanced Download Endpoint**:
- `GET /api/documents/:id` - Secure document download
- Headers required:
  - `Authorization`: Bearer token or session cookie
  - `Accept`: Supported MIME types
- Response headers:
  - `Content-Type`: Document MIME type
  - `Content-Disposition`: attachment; filename="..."
  - `Content-Length`: File size in bytes
  - `X-RateLimit-*`: Rate limit information
- Status codes:
  - 200: Successful download stream
  - 401: Unauthorized/expired session
  - 403: Forbidden/no access
  - 404: Document not found
  - 429: Rate limit exceeded
[Source: Derived from requirements]

### Streaming Implementation
**Node.js Streaming Pattern**:
```typescript
// Portal proxy streaming
const { stream, document } = await documentService.downloadDocument(documentId, user.id);

c.header("Content-Type", document.mimeType);
c.header("Content-Disposition", `attachment; filename="${sanitizeFilename(document.fileName)}"`);
c.header("Content-Length", document.fileSize.toString());
c.header("Cache-Control", "private, no-cache");

return c.body(stream);
```
[Source: Architecture patterns]

### Audit Logging Requirements
**Document Download Events**:
```typescript
// Log structure for downloads
{
  userId: string,
  impersonatedUserId?: string,
  action: "document.accessed" | "document.downloaded",
  resourceType: "document",
  resourceId: documentId,
  metadata: {
    bookingId: string,
    fileName: string,
    fileSize: number,
    downloadDuration?: number,
    bytesTransferred?: number,
    failed?: boolean,
    failureReason?: string
  },
  ipAddress: string,
  userAgent: string
}
```
[Source: architecture/data-models.md#auditlog]

### File Locations
Based on project structure:
- `/src/server/routes/documents.routes.ts` - Update download endpoint
- `/src/server/services/document.service.ts` - Enhance download method
- `/src/server/middleware/rate-limit.middleware.ts` - Add download limiter
- `/src/components/documents/document-list.tsx` - Update client downloads
- `/src/hooks/use-download-document.ts` - Create download hook
[Source: architecture/source-tree.md]

### Technical Constraints
- Must use Better Auth session validation
- Stream files without buffering in memory
- Support files up to 100MB efficiently
- Never expose S3 pre-signed URLs to client
- All downloads must be audited
- Rate limiting via Redis required
- Proper error handling without info leakage
[Source: architecture/coding-standards.md#security-requirements]

### Rate Limiting Configuration
**Download Rate Limits**:
```typescript
export const documentDownloadRateLimit = createRateLimiter({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 100, // 100 downloads per hour
  keyGenerator: (req) => req.user?.id || req.ip,
  skip: (req) => req.user?.role === 'admin',
  handler: (req, res) => {
    res.status(429).json({
      error: 'Too many download requests',
      retryAfter: res.get('X-RateLimit-Reset')
    });
  }
});
```
[Source: Derived from existing patterns]

### Client-Side Integration
**Secure Download Method**:
```typescript
// Instead of direct window.open()
async function downloadDocument(documentId: string) {
  try {
    const response = await fetch(`/api/documents/${documentId}`, {
      credentials: 'include',
      headers: { 'Accept': '*/*' }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        router.push('/login');
        return;
      }
      throw new Error('Download failed');
    }
    
    // Handle blob download with progress
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = getFilenameFromHeaders(response.headers);
    a.click();
    URL.revokeObjectURL(url);
  } catch (error) {
    toast.error('Download failed. Please try again.');
  }
}
```

## Testing

No test implementation required for this story as per user request.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-08-17 | 1.1 | Implemented portal-proxied download system | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4

### Debug Log References
- Enhanced download endpoint with comprehensive session validation and rate limiting
- Implemented secure streaming with range request support for resumable downloads  
- Added comprehensive audit logging for all document access attempts
- Created client-side download hook with progress tracking
- All error handling ensures no sensitive information exposure

### Completion Notes List
- Download endpoint now validates sessions and redirects to login on expiry
- Portal proxy pattern fully implemented - S3 URLs never exposed to client
- Rate limiting configured at 100 downloads/hour per user (admins exempt)
- Range requests supported for resumable downloads
- All document access comprehensively audited with IP and user agent tracking
- Client-side implementation uses secure fetch with progress tracking
- Error responses sanitized to prevent information leakage

### File List
- Modified: /src/server/routes/documents.routes.ts
- Modified: /src/server/services/document.service.ts  
- Modified: /src/lib/s3.ts
- Modified: /src/components/bookings/documents-section.tsx
- Created: /src/hooks/use-download-document.ts
- Created: /src/components/ui/progress.tsx

## QA Results