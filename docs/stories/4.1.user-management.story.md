# Story 4.1: User Management - Create & List Users

## Status
Ready for Review

## Story
**As an** admin,  
**I want** to create and manage users (admin, specialist, referrer) with organization assignments,  
**so that** I can efficiently onboard new users and manage access across multiple organizations.

## Acceptance Criteria
1. Admin-only page at `/admin/users` with create user form and user list table
2. User creation form includes: firstName, lastName, email, phone (optional), jobTitle (optional, default "N/A"), organization, team, role selection
3. "Send email invitation" checkbox that triggers Better Auth invitation flow when checked
4. When organization is selected, automatically select the first team of that organization
5. When creating a specialist user, also create corresponding entry in specialists table with acuityCalendarId
6. User list table shows all unique users with expandable/collapsible rows showing their organization memberships and roles
7. Search and filter capabilities: by name, email, organization, role, status (active/inactive)
8. (skip) Bulk actions: activate/deactivate users, resend invitations
9. User detail view showing all organization memberships, roles, and audit history
10. Form validation: unique email, required fields, valid acuityCalendarId for specialists

## Tasks / Subtasks
- [x] Create user management API endpoints (AC: 1, 2, 5)
  - [x] POST /api/admin/users - Create user with organization/team/role
  - [x] GET /api/admin/users - List all users with organization memberships
  - [x] GET /api/admin/users/:id - Get user details with all memberships
  - [x] PUT /api/admin/users/:id - Update user information
  - [x] POST /api/admin/users/:id/invite - Send/resend invitation email
  - [x] PUT /api/admin/users/:id/status - Activate/deactivate user
  - [x] GET /api/admin/organizations/:orgId/teams - Get teams for organization

- [x] Implement data access layer (AC: 5, 6)
  - [x] Create UserService with methods for complex user operations
  - [x] Implement createUserWithMembership method handling specialist case
  - [x] Create getUsersWithMemberships query with efficient joins
  - [x] Add transaction support for user + specialist creation
  - [x] Implement organization/team hierarchy queries

- [x] Build user creation form component (AC: 2, 3, 4, 10)
  - [x] Create /src/app/admin/users/page.tsx with layout
  - [x] Build CreateUserForm with react-hook-form and zod validation
  - [x] Implement dynamic team dropdown based on selected organization
  - [x] Add conditional acuityCalendarId field for specialist role
  - [x] Integrate with Better Auth invitation API when checkbox selected
  - [x] Add loading states and error handling

- [x] Develop user list table component (AC: 6, 7)
  - [x] Create UserListTable with Tanstack Table
  - [x] Implement expandable rows showing organization memberships
  - [x] Design membership display: Organization (Role) | Team format
  - [x] Add search bar with debounced API calls
  - [x] Create filter dropdowns for organization, role, status
  - [x] Implement pagination with server-side data fetching

- [ ] (skip) Add bulk operations support (AC: 8)
  - [ ] Add row selection checkboxes to table
  - [ ] Create bulk actions dropdown menu
  - [ ] Implement bulk activate/deactivate API endpoint
  - [ ] Add bulk invite resend functionality
  - [ ] Show progress indicator for bulk operations

- [x] Create user detail modal/page (AC: 9)
  - [x] Build UserDetailView component
  - [x] Display all organization memberships in cards/list
  - [x] Show audit log timeline for user actions
  - [x] Add edit capabilities for user information
  - [x] Include specialist details if applicable

- [x] Add comprehensive validation (AC: 10)
  - [x] Email uniqueness check on blur
  - [x] Acuity calendar ID validation for specialists
  - [x] Required field validation with clear error messages
  - [x] Server-side validation in API endpoints
  - [x] Handle edge cases (existing email, invalid org/team)

## Dev Notes

### Data Models

**User-Organization Relationship**:
Users are linked to organizations through the `members` table with specific roles:
```typescript
interface Member {
  id: string;
  organizationId: string;
  userId: string;
  role: 'owner' | 'manager' | 'team_lead' | 'referrer' | 'specialist';
  teamId?: string;
  createdAt: Date;
}
```

**Specialist Creation Flow**:
1. Create user in Better Auth users table
2. Add member record linking user to organization with 'specialist' role
3. Create specialist record with userId and acuityCalendarId
4. Send invitation email if checkbox selected

**Display Strategy for Multi-Organization Users**:
- Primary table row shows user info (name, email, primary role)
- Expandable section shows all memberships as cards/rows:
  ```
  John Doe | john@example.com | [Expand ▼]
    └─ Org: MediLaw Firm | Role: Referrer | Team: Personal Injury
    └─ Org: WorkComp Associates | Role: Manager | Team: Claims
  ```

### API Response Structure

**GET /api/admin/users Response**:
```typescript
interface UserListResponse {
  users: Array<{
    id: string;
    email: string;
    firstName: string;
    lastName: string;
    phone?: string;
    jobTitle?: string;
    isActive: boolean;
    createdAt: Date;
    memberships: Array<{
      organizationId: string;
      organizationName: string;
      teamId?: string;
      teamName?: string;
      role: string;
      joinedAt: Date;
    }>;
    specialist?: {
      id: string;
      acuityCalendarId: string;
      specialty: string;
      location?: string;
    };
  }>;
  pagination: {
    total: number;
    page: number;
    pageSize: number;
  };
}
```

### Better Auth Integration

**Invitation Flow**:
```typescript
// When "Send email invitation" is checked
await auth.admin.createInvitation({
  email: formData.email,
  role: "user", // System role
  expiresIn: 60 * 60 * 24 * 7, // 7 days
  data: {
    firstName: formData.firstName,
    lastName: formData.lastName,
    organizationId: formData.organizationId,
    memberRole: formData.role, // Organization role
  }
});
```

### Component Architecture

```
/app/admin/users/
├── page.tsx                    # Main page with table and create button
├── components/
│   ├── CreateUserDialog.tsx    # Modal with creation form
│   ├── UserListTable.tsx       # Main table component
│   ├── UserDetailDialog.tsx    # User detail view modal
│   ├── UserFilters.tsx         # Filter controls
│   └── BulkActions.tsx         # Bulk action dropdown
```

### Validation Rules

1. **Email**: Must be unique across system, valid email format
2. **Phone**: Optional, but if provided must be valid format
3. **Organization**: Required, must exist in database
4. **Team**: Required, must belong to selected organization
5. **Specialist**: If role=specialist, acuityCalendarId required and must be unique
6. **Names**: Required, min 2 characters, max 50 characters

### Testing

**Unit Tests**:
- `/tests/unit/services/user.service.test.ts`
- `/tests/unit/components/admin/users/*.test.tsx`

**Integration Tests**:
- `/tests/integration/api/admin/users.test.ts`
- `/tests/integration/flows/user-creation.test.ts`

**E2E Tests**:
- User creation flow with all roles
- Multi-organization user display
- Bulk operations
- Search and filter functionality

### Security Considerations

1. Only system admins can access user management
2. Email invitations expire after 7 days
3. Audit log all user creation/modification actions
4. Rate limit bulk operations
5. Validate organization/team access rights

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-18 | 1.0 | Initial story creation | BMad Master |
| 2025-01-18 | 1.1 | Implementation completed | James (Dev Agent) |

## Dev Agent Record
_Implementation completed_

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- API endpoint creation and validation
- UserService implementation with transaction support
- Form components with TanStack Form integration
- Table components with expandable rows
- Audit service integration

### Completion Notes List
- All API endpoints created with proper validation using ArkType
- UserService implemented with full CRUD operations and membership management
- Specialist creation integrated with transaction support
- User list table with expandable rows showing memberships
- User detail modal with edit capabilities and audit history
- Comprehensive validation on both client and server side
- Better Auth integration for user creation and invitation
- Team selection automatically updates based on organization

### File List
- /src/server/routes/admin.routes.ts (modified)
- /src/server/services/user.service.ts (modified)
- /src/server/services/audit.service.ts (modified)
- /src/types/user.ts (modified)
- /src/app/admin/users/page.tsx (created)
- /src/app/admin/users/components/CreateUserDialog.tsx (created)
- /src/app/admin/users/components/UserListTable.tsx (created)
- /src/app/admin/users/components/UserFilters.tsx (created)
- /src/app/admin/users/components/UserDetailDialog.tsx (created)

## QA Results
_To be populated during QA review_