# Story 3.2: Document Upload Interface

## Status
Ready for Review

## Story
**As a** user,  
**I want** to upload documents to a booking after it's created,  
**so that** all examination-related files are centrally stored.

## Acceptance Criteria
1. Document upload section appears on booking detail page after booking creation
2. Drag-and-drop interface supports multiple file uploads
3. File type validation allows common formats (PDF, DOCX, images, audio for dictations)
4. Maximum file size of 100MB enforced with clear error messaging
5. Progress indicators show upload status for each file
6. Document categories available: consent forms, briefs, reports, dictations, other
7. Successful uploads immediately visible in document list
8. Upload errors provide specific guidance for resolution

## Tasks / Subtasks
- [x] Adapt Origin UI Upload Component (AC: 2, 3, 4, 5)
  - [x] Download and integrate component from https://originui.com/r/comp-553.json
  - [x] Modify file size limit from 5MB to 100MB
  - [x] Extend accepted file types to include audio formats (MP3, M4A, WAV)
  - [x] Replace simulated upload with actual API integration
  - [x] Keep drag-and-drop and progress tracking features
  - [x] Adapt styling to match application design system
- [x] Update DocumentsSection component (AC: 1, 7)
  - [x] Replace placeholder in /src/components/bookings/documents-section.tsx
  - [x] Integrate adapted upload component
  - [x] Add document list display with category grouping
  - [x] Implement real-time updates after successful uploads
  - [x] Add empty state for bookings without documents
  - [x] Include document count by category
- [x] Enhance upload component with categorization (AC: 6)
  - [x] Add category selector to upload interface
  - [x] Map file types to suggested categories
  - [x] Audio files default to 'dictation' category
  - [x] Allow user to override suggested category
  - [x] Include category in upload request
- [x] Integrate with document API (AC: 5, 7, 8)
  - [x] Replace simulated upload with real POST /api/documents calls
  - [x] Implement actual file upload with XMLHttpRequest for progress
  - [x] Handle multipart uploads for files >5MB
  - [x] Map component's progress tracking to real upload progress
  - [x] Handle rate limiting (50/hour) with user-friendly messages
  - [x] Display specific error messages from API responses
- [x] Create upload hooks and state management (AC: 7, 8)
  - [x] Create /src/hooks/use-upload-document.ts
  - [x] Adapt component's useFileUpload hook for real uploads
  - [x] Implement TanStack Query mutation with optimistic updates
  - [x] Handle multiple concurrent uploads
  - [x] Invalidate document list query on success
  - [x] Add retry mechanism for failed uploads
- [x] Polish UI and error handling (AC: 8)
  - [x] Customize error messages for common scenarios
  - [x] Add toast notifications for upload outcomes
  - [x] Show remaining upload quota (X/50 per hour)
  - [x] Add help text for accepted formats
  - [x] Ensure mobile responsiveness

## Dev Notes

### Previous Story Insights
- S3 infrastructure and document service implemented in Story 3.1
- API endpoints ready: POST /api/documents with multipart support
- Rate limiting at 50 uploads per hour per user
- Document model includes category field for classification
- Role-based access control via booking service integration
- Multipart upload triggers for files >5MB
[Source: Story 3.1 completion notes]

### Origin UI Upload Component
**Component Features**:
- Drag-and-drop interface with visual feedback
- Multiple file upload support (currently limited to 6 files)
- Progress bars for each file during upload
- File type validation and icon representation
- Preview generation for image files
- Currently uses simulated upload - needs real API integration

**Modifications Required**:
- Increase file size limit from 5MB to 100MB
- Extend file type support for audio formats
- Replace simulated upload with actual API calls
- Add document category selection
- Integrate with existing TanStack Query patterns
- Remove 6-file limit or make it configurable
[Source: https://originui.com/r/comp-553.json]

### Data Models
**Document Upload Request**:
```typescript
interface DocumentUploadRequest {
  file: File;
  bookingId: string;
  category: 'consent_form' | 'brief' | 'report' | 'dictation' | 'other';
}

interface Document {
  id: string;
  bookingId: string;
  fileName: string;
  fileSize: number;
  mimeType: string;
  category: string;
  uploadedById: string;
  createdAt: Date;
}
```
[Source: Story 3.1, architecture/data-models.md#document]

### API Specifications
**Upload Endpoint**:
- `POST /api/documents` - Multipart form upload
- Form fields:
  - `file`: File object (required)
  - `bookingId`: string (required)
  - `category`: string (required)
- Returns: Document metadata with ID
- Rate limited: 50 uploads/hour/user
- Max file size: 100MB
[Source: Story 3.1 implementation]

### File Locations
Based on project structure:
- `/src/components/bookings/documents-section.tsx` - Update existing
- `/src/components/documents/document-upload.tsx` - Adapted Origin UI component
- `/src/hooks/use-upload-document.ts` - Real upload implementation
- `/src/hooks/use-file-upload.ts` - Adapted from Origin UI
- `/src/services/documents.service.ts` - API integration
[Source: architecture/source-tree.md#frontend-structure]

### Technical Constraints
- Must integrate with TanStack Query for state management
- Use existing document service from Story 3.1
- Maintain 100MB file size limit
- Support audio formats for dictations
- Handle multipart uploads for files >5MB
- Never expose S3 URLs to client
- Follow mobile-first responsive design
[Source: architecture/coding-standards.md#critical-fullstack-rules]

### File Type Configuration
**Extend Origin UI's File Types**:
```typescript
const ACCEPTED_TYPES = {
  // Keep existing from Origin UI
  'application/pdf': ['.pdf'],
  'image/*': ['.jpg', '.jpeg', '.png', '.gif', '.webp'],
  // Add for medical documents
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  // Add audio for dictations
  'audio/mpeg': ['.mp3'],
  'audio/mp4': ['.m4a'],
  'audio/wav': ['.wav'],
  'audio/x-m4a': ['.m4a']
};
```

### Progress Tracking Integration
**Replace Simulated Upload**:
```typescript
// Instead of Origin UI's simulated progress
// Use real XMLHttpRequest progress
const xhr = new XMLHttpRequest();
xhr.upload.addEventListener('progress', (e) => {
  if (e.lengthComputable) {
    const progress = Math.round((e.loaded / e.total) * 100);
    updateFileProgress(fileId, progress);
  }
});
```

### Category Enhancement
**Add to Upload Interface**:
```typescript
interface UploadedFile {
  // Existing Origin UI properties
  id: string;
  file: File;
  progress: number;
  // Add for our use case
  category: DocumentCategory;
  bookingId: string;
}
```

## Testing

No test implementation required for this story as per user request.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-08-17 | 1.1 | Updated to use Origin UI upload component | Bob (Scrum Master) |
| 2025-08-17 | 1.2 | Story completed and ready for review | James (Developer) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-20250514

### Debug Log References
- No debug logs generated during implementation

### Completion Notes List
- Successfully adapted Origin UI upload component with all required modifications
- Integrated with existing document service and API endpoints from Story 3.1
- Implemented real-time progress tracking using XMLHttpRequest
- Added document categorization with smart suggestions based on file type
- Created comprehensive error handling with specific messages for all scenarios
- Implemented rate limiting feedback showing retry time
- Added document grouping by category in the display
- Maintained mobile responsiveness throughout
- All acceptance criteria met and validated

### File List
- Created: /src/components/documents/document-upload.tsx
- Created: /src/hooks/use-upload-document.ts
- Created: /src/hooks/use-documents.ts
- Modified: /src/components/bookings/documents-section.tsx
- Modified: /src/app/(dashboard)/bookings/[id]/booking-detail-client.tsx

## QA Results

### Review Date: 2025-08-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The document upload implementation successfully delivers all 8 acceptance criteria with clean, maintainable code. The Origin UI component was properly adapted, with file size limit increased to 100MB and audio format support added. Real-time upload progress tracking works seamlessly with XMLHttpRequest integration. The implementation follows project patterns with proper error handling and user feedback.

### Key Strengths
- Excellent UI/UX with drag-and-drop, progress bars, and clear error messages
- Smart category suggestions based on file type and name
- Proper integration with TanStack Query for state management
- Comprehensive error handling including rate limit feedback
- Clean component architecture with good separation of concerns
- Mobile responsive design maintained throughout

### Areas for Improvement
- Download endpoint opens in new tab without visible auth validation
